// Reveal on scroll
const reveals = document.querySelectorAll(".reveal");
const io = new IntersectionObserver((entries) => {
  for (const e of entries) if (e.isIntersecting) e.target.classList.add("is-visible");
}, { threshold: 0.12 });
reveals.forEach(el => io.observe(el));

// Slider (hero)
const track = document.getElementById("track");
const dots = document.getElementById("dots");
const prev = document.getElementById("prev");
const next = document.getElementById("next");

if (track && dots && prev && next) {
  const slides = Array.from(track.children);
  let index = 0;

  slides.forEach((_, i) => {
    const b = document.createElement("button");
    b.className = "dot" + (i === 0 ? " is-active" : "");
    b.type = "button";
    b.setAttribute("aria-label", `Aller au projet ${i + 1}`);
    b.addEventListener("click", () => goTo(i));
    dots.appendChild(b);
  });
  const dotButtons = Array.from(dots.children);

  function render() {
    track.style.transform = `translateX(${-index * 100}%)`;
    dotButtons.forEach((d, i) => d.classList.toggle("is-active", i === index));
  }
  function goTo(i) { index = (i + slides.length) % slides.length; render(); }

  prev.addEventListener("click", () => goTo(index - 1));
  next.addEventListener("click", () => goTo(index + 1));

  let startX = null;
  track.addEventListener("touchstart", (e) => startX = e.touches[0].clientX, { passive: true });
  track.addEventListener("touchend", (e) => {
    if (startX === null) return;
    const dx = e.changedTouches[0].clientX - startX;
    if (Math.abs(dx) > 50) goTo(dx < 0 ? index + 1 : index - 1);
    startX = null;
  }, { passive: true });

  render();
}

// Helpers
function safeJsonParse(s, fallback) {
  try { return JSON.parse(s); } catch { return fallback; }
}

function setActiveChip(groupSelector, btn) {
  document.querySelectorAll(groupSelector).forEach(b => b.classList.remove("is-active"));
  btn.classList.add("is-active");
}

function matchesTag(tagString, filter) {
  if (filter === "all") return true;
  const tags = (tagString || "").split(/\s+/).filter(Boolean);
  return tags.includes(filter);
}

// Tools: modal + search + filter
const toolModal = document.getElementById("toolModal");
const mTitle = document.getElementById("mTitle");
const mSubtitle = document.getElementById("mSubtitle");
const mBody = document.getElementById("mBody");
const mLinks = document.getElementById("mLinks");
const mClose = document.getElementById("mClose");

const toolButtons = Array.from(document.querySelectorAll(".tool"));
const toolSearch = document.getElementById("toolSearch");

function openToolModal(btn) {
  const title = btn.dataset.title || "";
  const subtitle = btn.dataset.subtitle || "";
  const body = btn.dataset.body || "";
  const links = safeJsonParse(btn.dataset.links || "[]", []);

  mTitle.textContent = title;
  mSubtitle.textContent = subtitle;
  mBody.textContent = body;

  mLinks.innerHTML = "";
  links.forEach(l => {
    const a = document.createElement("a");
    a.className = "btn btn--ghost";
    a.href = l.href;
    a.textContent = l.label;
    mLinks.appendChild(a);
  });

  toolModal?.showModal?.();
}

toolButtons.forEach(btn => btn.addEventListener("click", () => openToolModal(btn)));
mClose?.addEventListener("click", () => toolModal.close());
toolModal?.addEventListener("click", (e) => {
  const rect = toolModal.getBoundingClientRect();
  const inDialog = rect.top <= e.clientY && e.clientY <= rect.bottom && rect.left <= e.clientX && e.clientX <= rect.right;
  if (!inDialog) toolModal.close();
});

// Tool filters (chips)
let toolFilter = "all";
document.querySelectorAll("[data-tool-filter]").forEach(chip => {
  chip.addEventListener("click", () => {
    toolFilter = chip.dataset.toolFilter;
    setActiveChip("[data-tool-filter]", chip);
    filterTools();
  });
});

function filterTools() {
  const q = (toolSearch?.value || "").trim().toLowerCase();
  toolButtons.forEach(btn => {
    const title = (btn.dataset.title || "").toLowerCase();
    const subtitle = (btn.dataset.subtitle || "").toLowerCase();
    const body = (btn.dataset.body || "").toLowerCase();
    const tags = btn.dataset.tags || "";

    const okTag = matchesTag(tags, toolFilter);
    const okSearch = !q || title.includes(q) || subtitle.includes(q) || body.includes(q) || tags.toLowerCase().includes(q);

    btn.style.display = (okTag && okSearch) ? "" : "none";
  });
}
toolSearch?.addEventListener("input", filterTools);

// Projects: modal + search + filter
const projectModal = document.getElementById("projectModal");
const pmTitle = document.getElementById("pmTitle");
const pmSubtitle = document.getElementById("pmSubtitle");
const pmBody = document.getElementById("pmBody");
const pmLinks = document.getElementById("pmLinks");
const pmClose = document.getElementById("pmClose");

const projectCards = Array.from(document.querySelectorAll(".pcard"));
const projectSearch = document.getElementById("projectSearch");
const pMoreBtns = Array.from(document.querySelectorAll(".pMore"));

function openProjectModal(btn) {
  pmTitle.textContent = btn.dataset.title || "";
  pmSubtitle.textContent = btn.dataset.subtitle || "";
  pmBody.textContent = btn.dataset.body || "";

  const links = safeJsonParse(btn.dataset.links || "[]", []);
  pmLinks.innerHTML = "";
  links.forEach(l => {
    const a = document.createElement("a");
    a.className = "btn btn--ghost";
    a.href = l.href;
    a.textContent = l.label;
    pmLinks.appendChild(a);
  });

  projectModal?.showModal?.();
}

pMoreBtns.forEach(b => b.addEventListener("click", () => openProjectModal(b)));
pmClose?.addEventListener("click", () => projectModal.close());
projectModal?.addEventListener("click", (e) => {
  const rect = projectModal.getBoundingClientRect();
  const inDialog = rect.top <= e.clientY && e.clientY <= rect.bottom && rect.left <= e.clientX && e.clientX <= rect.right;
  if (!inDialog) projectModal.close();
});

let projectFilter = "all";
document.querySelectorAll("[data-project-filter]").forEach(chip => {
  chip.addEventListener("click", () => {
    projectFilter = chip.dataset.projectFilter;
    setActiveChip("[data-project-filter]", chip);
    filterProjects();
  });
});

function filterProjects() {
  const q = (projectSearch?.value || "").trim().toLowerCase();
  projectCards.forEach(card => {
    const title = (card.dataset.title || "").toLowerCase();
    const tags = (card.dataset.tags || "");
    const okTag = matchesTag(tags, projectFilter);
    const okSearch = !q || title.includes(q) || tags.toLowerCase().includes(q);
    card.style.display = (okTag && okSearch) ? "" : "none";
  });
}
projectSearch?.addEventListener("input", filterProjects);
